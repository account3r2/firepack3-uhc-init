local worldDiameter = 4000;

local uhc = dofile("libuhccore");
uhc.interface = dofile("libuhcinterface");

local commandBlock = peripheral.find("command");
local mon = peripheral.find("monitor");

local function init()
	print("Initializing...");
	uhc.say("Initializing UHC... This may take a few minutes.");

	print("Initializing the interface...");
	uhc.interface.init(mon);

	print("Initializing gamerules...");
	uhc.gamerule.init();
	uhc.gamerule.eternalNight(true);
	uhc.gamerule.difficultyCycle(3);
	uhc.setSpawn(0, 151, 0);

	print("Initializing teams...");
	uhc.teams.init();
	uhc.teams.friendlyFire(false);
	uhc.teams.seeTeamInvisibles(true);
	uhc.teams.seeNametags(true);

	print("Initializing scoreboard...");
	uhc.scoreboard.init();
	uhc.scoreboard.heartsInTab(true);

	print("Generating chunks...");
	uhc.generateWorld(worldDiameter, uhc.interface.draw.progress, mon);

	print("Generating world border...");
	uhc.generateBorder(worldDiameter, uhc.interface.draw.progress, mon);

	rs.setOutput("left", false);		-- timemonitord/Player Controller

	print("Done!");
	uhc.say("Done!");

	showInterface = true;
end

local function gameStart()
	print("Starting the game...");

	print("Starting countdown...");
	uhc.interface.draw.countdown(10, mon);
	commands.exec("playsound note.pling @a ~ ~ ~ 1000 2 1");

	uhc.interface.resetMonitor(mon)
	uhc.interface.write.center("The game has started!", mon, 1)

	sleep(0.5);

	uhc.gamerule.eternalDayFix(3);
	uhc.players.spread(worldDiameter, "default", true, true);
	uhc.players.reset(0);
	uhc.setSpawn(0, 151, 0);
	commands.exec("tp @a[team=] 0 151 0");

	rs.setOutput("left", true);			-- timemonitord/Player Controller

	print("The game has started!");
	uhc.say("The game has started! No killing in the first 20 minutes!");

	uhc.interface.idle("(server)Â² UHC II", mon, "gamemode 2 @a[m=0,r=20]");
end

init();

while showInterface do
	local startGame = uhc.interface.draw.main(mon, commandBlock);

	if startGame then
		gameStart();
	end
end
